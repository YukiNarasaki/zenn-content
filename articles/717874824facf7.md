---
title: "ã€Azureã€‘Terraformã§AzureVMã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸ"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure", "Terraform"]
published: true
---

AzureCLIã§å®Ÿè¡Œã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’GitHubã§ç®¡ç†ã—ã‚ˆã†ã¨æ€ã„ã€èª¿ã¹ã¦ã„ãŸã‚‰Terraformã¨ã„ã†ç®¡ç†ãƒ„ãƒ¼ãƒ«ãŒå‡ºã¦ããŸã®ã§ä½¿ã£ã¦ã¿ãŸã€‚

# Terraformã¨ã¯ï¼Ÿ

**Terraformï¼ˆãƒ†ãƒ©ãƒ•ã‚©ãƒ¼ãƒ ï¼‰** ã¯ã€**ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ã‚³ãƒ¼ãƒ‰ï¼ˆInfrastructure as Code, IaCï¼‰ã¨ã—ã¦ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«** ã§ã™ã€‚HashiCorpï¼ˆãƒã‚·ã‚³ãƒ¼ãƒ—ï¼‰ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚„ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’è‡ªå‹•åŒ–ã—ã¦ç®¡ç†ã§ãã¾ã™ã€‚

https://www.hashicorp.com/ja/products/terraform

## Terraformã®ç‰¹å¾´

1. **ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ï¼ˆIaC: Infrastructure as Codeï¼‰**
    - Terraform ã‚’ä½¿ã†ã¨ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ï¼ˆä»®æƒ³ãƒã‚·ãƒ³ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã©ï¼‰ã‚’ **ã‚³ãƒ¼ãƒ‰ï¼ˆHCL: HashiCorp Configuration Languageï¼‰** ã§å®šç¾©ã—ã€è‡ªå‹•ã§ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
2. **ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œ**
    - Terraform ã¯ **AWS, Azure, Google Cloudï¼ˆGCPï¼‰ãªã©ã®ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒ** ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
3. **å®£è¨€çš„ãªæ§‹æˆç®¡ç†**
    - **ã€Œã“ã®çŠ¶æ…‹ã«ã—ãŸã„ã€** ã¨ã„ã† **æœ€çµ‚çš„ãªçŠ¶æ…‹** ã‚’ã‚³ãƒ¼ãƒ‰ã§è¨˜è¿°ã—ã€Terraform ãŒãã®çŠ¶æ…‹ã«ã™ã‚‹ã‚ˆã†è‡ªå‹•çš„ã«é©ç”¨ã€‚
    - å¤‰æ›´ãŒå¿…è¦ãªéƒ¨åˆ†ã®ã¿é©ç”¨ã•ã‚Œã€æ‰‹å‹•è¨­å®šã®ãƒŸã‚¹ã‚’é˜²ã’ã‚‹ã€‚
4. **ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†**
    - Terraform ã¯ **ã€Œã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸã‹ã€** ã‚’ .tfstate ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã€å¤‰æ›´ã®å·®åˆ†ã‚’é©ç”¨ã€‚
5. **ãƒ—ãƒ©ãƒ³ãƒ»é©ç”¨ã®ç¢ºèª**
    - å¤‰æ›´å‰ã« terraform plan ã§ **ã©ã®ãƒªã‚½ãƒ¼ã‚¹ãŒè¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã•ã‚Œã‚‹ã‹** ã‚’ç¢ºèªã§ãã‚‹ã€‚
    - terraform apply ã§å®Ÿéš›ã«ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã€‚

# ç›®æ¨™

Terraformã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ã®ã¿ã§AzureVMãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚

# å‰ææ¡ä»¶

- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¯Mac
- AzureCLIã‚’äº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã¯vscodeã§ã™
- Terraformãƒ•ã‚¡ã‚¤ãƒ«ã¯GitHubã§ç®¡ç†ã—ã¦ã„ã¾ã™

# ç’°å¢ƒæ§‹ç¯‰

## Terraformã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

Terraformã®Â **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆtfenvï¼‰**Â ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```diff bash
brew install tfenv
```

åˆ©ç”¨å¯èƒ½ãªTerraformãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚åŸ·ç­†æ®µéšã§ã¯ã€`1.11.2`ãŒæœ€æ–°ç‰ˆã§ã—ãŸã€‚

```diff bash
tfenv list-remote
```

Terraformï¼ˆ1.11.2ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```diff bash
tfenv install 1.11.2
```

ãƒ­ãƒ¼ã‚«ãƒ«PCä¸Šã§ä½¿ç”¨ã§ãã‚‹Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
tfenv list
```

Terraformï¼ˆ1.11.2ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

```
tfenv use 1.11.2
```

`tfenv use`Â ã‚’å®Ÿè¡Œå¾Œã€ä¸‹è¨˜ã®ã‚ˆã†ãªçµæœã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ï¼

```
Switching default version to v1.11.2
Default version (when not overridden by .terraform-version or TFENV_TERRAFORM_VERSION) is now: 1.11.2
```

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²ã‚’è¡Œã†

Azureãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Microsoft Entra IDã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚

![image.png](/images/717874824facf7-01.png)

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

![image.png](/images/717874824facf7-02.png)

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID**ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚

![image.png](/images/717874824facf7-03.png)

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ç™ºè¡Œå¾Œã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆå€¤ï¼‰ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚

![image.png](/images/717874824facf7-04.png)

## **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«Azureãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã™ã‚‹**

ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ãŸã„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€Œã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆIAMï¼‰ã€ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®**å…±åŒä½œæˆè€…**ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

![image.png](/images/717874824facf7-05.png)

![image.png](/images/717874824facf7-06.png)

# **ãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰**

## **Azureã®è³‡æ ¼æƒ…å ±ã‚’Terraformã«è¨­å®šã™ã‚‹**

vscodeã«ä¸‹è¨˜2ã¤ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

- HashiCorp Terraform
- Azure Terraform

![image.png](/images/717874824facf7-07.png)

`<ä»»æ„ã®åå‰>.tfvars`Â ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```diff hcl:param.tfvars
provider_credentials = {
  subscription_id  = "ï¼œæ§‹ç¯‰ã—ãŸã„å…ˆã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDï¼"
  tenant_id        = "ï¼œMicrosoft Entra IDã®ãƒ†ãƒŠãƒ³ãƒˆIDï¼"
  sp_client_id     = "ï¼œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDï¼"
  sp_client_secret = "ï¼œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼"
}
```

:::message
GitHubãªã©ã§ç®¡ç†ã™ã‚‹å ´åˆã¯ã€`.gitignore`ã«`*.tfvars`ã‚’è¿½åŠ ã—ã¦ã€è³‡æ ¼æƒ…å ±ã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã«Pushã—ãªã„ã‚ˆã†ã«æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„
:::

```
# .tfvars files
*.tfvars
```

## **Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹**

`<ä»»æ„ã®åå‰>.tfvars`Â ã¨åŒã˜éšå±¤ã«`main.tf`ã¨`variables.tf`ã‚’ä½œæˆã—ã¾ã™ã€‚

```diff hcl:main.tf
provider "azurerm" {
  subscription_id = var.provider_credentials.subscription_id
  tenant_id       = var.provider_credentials.tenant_id
  client_id       = var.provider_credentials.sp_client_id
  client_secret   = var.provider_credentials.sp_client_secret
  features {}
}

resource "azurerm_resource_group" "rg" {
  name     = "rg-tr-001"
  location = var.location
}

resource "azurerm_virtual_network" "vnet" {
  name                = "vnet-tr-001"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  address_space       = ["10.0.0.0/16"]
}

resource "azurerm_subnet" "subnet" {
  name                 = "snet-tr-001"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.vnet.name
  address_prefixes     = ["10.0.1.0/24"]
}

resource "azurerm_public_ip" "public_ip" {
  name                = "pip-tr-001"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  allocation_method   = "Static"
}

resource "azurerm_network_interface" "nic" {
  name                = "nic-tr-001"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  ip_configuration {
    name                          = "nicconfig-tr-001"
    subnet_id                     = azurerm_subnet.subnet.id
    public_ip_address_id          = azurerm_public_ip.public_ip.id
    private_ip_address_allocation = "Static"
    private_ip_address            = "10.0.1.4"  # æ˜ç¤ºçš„ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®š
  }
}

resource "azurerm_linux_virtual_machine" "vm" {
  name                = "vm-tr-001"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  size                = "Standard_B1s"
  admin_username      = "adminuser"
  admin_password      = "*******" # ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
  disable_password_authentication = false # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’æœ‰åŠ¹åŒ–

  network_interface_ids = [
    azurerm_network_interface.nic.id
  ]

  os_disk {
    caching              = "ReadWrite"
    storage_account_type = "StandardSSD_LRS"
  }

  source_image_reference {
    publisher = "Canonical"
    offer     = "0001-com-ubuntu-server-focal"
    sku       = "20_04-lts-gen2"
    version   = "latest"
  }
}
```

```diff hcl:variables.tf
variable "provider_credentials" {
  type = object({
    subscription_id  = string
    tenant_id        = string
    sp_client_id     = string
    sp_client_secret = string
  })
}

variable "location" {
  type    = string
  default = "japaneast"
}
```

## **Terraformã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹**

Terraformãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’åˆæœŸåŒ–(init)ã—ã¾ã™ã€‚

```bash
terraform init
```

æ§‹ç¯‰ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã®è¨ˆç”»(plan)ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
terraform plan -var-file=param.tfvars
```

ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰(apply)ã—ã¾ã™ã€‚

```bash
terraform apply -var-file=param.tfvars
```

planã¨åŒã˜çµæœãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã€ç¢ºèªã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚`yes`ã¨å…¥åŠ›ã—ã€å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
Plan: 6 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
```

ä¸‹è¨˜ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°å®Œäº†ã§ã™ã€‚

```bash
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

## **æ§‹ç¯‰ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã™ã‚‹**

ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒãƒ¼ã‚¿ãƒ«ã§ç¢ºèªã—ã¾ã™ã€‚

![image.png](/images/717874824facf7-08.png)

**æ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚Œã°å®Œäº†ã§ã™ï¼**

# å‚è€ƒæ–‡çŒ®

https://zenn.dev/murakami_koki/articles/43d2294d9761be
https://persol-serverworks.co.jp/blog/terraform/terraformpushgitignore.html